@page "/game"
@using GuessTheNumberClient.Models

<EditForm Model="@player" OnValidSubmit="HandleGuess">
    <DataAnnotationsValidator />
    @if (!gameOver)
    {
        <label for="Input">Enter your guess.</label>
        <InputNumber id="Input" @bind-Value="player.Guess" />
        <ValidationMessage For="@(() => player.Guess)" /> <br />
        <button type="submit">Submit Guess</button>
        <p>@feedbackMessage</p>
    }
    else
    {
        <p>@feedbackMessage</p>
        <button type="button" @onclick="HandleRestart">Restart Game</button>
    }
</EditForm>

<p>Attempts: @player.CurrentAttempts</p>

@if (player.BestAttempt is null)
{
    <p>Best Attempt: Not available</p>
}
else
{
    <p>Best Attempt: @player.BestAttempt</p>  
}


@code {
    private Player player = new();
    private int secretNumber;
    private string feedbackMessage = string.Empty;
    private bool gameOver = false;
    private readonly Random random = new();

    protected override void OnInitialized()
    {
        secretNumber = random.Next(1, 51);
    }

    private void HandleGuess()
    {
        player.CurrentAttempts++;

        if (player.Guess < secretNumber)
        {
            feedbackMessage = "Low! Try again.";
        }
        else if (player.Guess > secretNumber)
        {
            feedbackMessage = "High! Try again.";
        }
        else
        {
            feedbackMessage = $"Congratulations! You've guessed the number {secretNumber} in {player.CurrentAttempts} attempts.";
            if (player.BestAttempt is null || player.CurrentAttempts < player.BestAttempt)
            {
                player.BestAttempt = player.CurrentAttempts;
            }
            gameOver = true;
        }
        player.Guess = null;
        // player.BestAttempt = player.CurrentAttempts;
    }
    
    private void HandleRestart()
    {
        secretNumber = random.Next(1, 51);
        player.Guess = null;
        player.CurrentAttempts = 0;
        feedbackMessage = string.Empty;
        gameOver = false;
    }
}

